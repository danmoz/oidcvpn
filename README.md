# OpenVPN Community + OIDC Plugin Docker Image

This repository builds a Docker image for OpenVPN Community Edition with the openvpn-auth-oauth2 
plugin, supporting OIDC authentication. 

The image includes an init.sh which can generate the initial setup files (configs, keys and certs)
which are then uploaded to an S3 bucket, where they can be tweaked as required.  They wil be downloaded and installed on container startup. 

## Setup Instructions

### Prerequisites
- Docker
- An S3 bucket to store the configuration files
- AWS credentials (API keys or IAM Role) with permissions to read and write to the bucket

### Getting started
1. Clone this repository.
2. Generate the initial config and certs:
   ```sh
   OIDCVPN_S3_URI=s3://<bucket name>/openvpn
   docker-compose run --remove-orphans --build oidcvpn /init.sh 
   ```
3. Run OpenVPN
   ```sh
   docker-compose run oidcvpn
   ```
   
### Entrypoint Script
The image uses an entrypoint script (`entrypoint.sh`) that:
- Syncs the entire S3 directory specified by `OIDCVPN_S3_URI` to `/etc/openvpn`
- Starts OpenVPN with the downloaded config

### Environment Variables

| Variable                     | Description                                                         | Required | Example                                          |
|------------------------------|---------------------------------------------------------------------|----------|--------------------------------------------------|
| OIDCVPN_S3_URI               | S3 URI to the directory containing all OpenVPN config and key files | Yes      | s3://yourbucket/openvpn                          |
| AWS_ACCESS_KEY_ID            | AWS access key for S3 access (if not using IAM role)                | No       | AKIA...                                          |
| AWS_SECRET_ACCESS_KEY        | AWS secret key for S3 access (if not using IAM role)                | No       | wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY         |
| AWS_SESSION_TOKEN            | AWS session token for temporary credentials (optional)              | No       | ...                                              |

## Security Notes
- Do not bake sensitive configs or credentials into the image.
- **Prefer IAM roles for ECS tasks for better security and easier credential management.**

### Deploying on ECS
1. Run the init.sh script to generate the initial conf and upload to S3.
2. Modify the `server.conf` as required
3. Set the required env vars in your ECS Task Definition
4. On container startup, all files in this S3 directory will be synced to `/etc/openvpn` automatically.
5. OpenVPN will start using `/etc/openvpn/server.conf`.

### OIDC Authentication (Google, etc.)

To enable OIDC authentication (e.g., with Google), edit the `oauth2.yaml` file in your S3 bucket. 
This file is generated by `init.sh` and contains all required fields for the openvpn-auth-oauth2 plugin in YAML format.

### How to Create Google OIDC Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/).
2. Create a new project (if needed).
3. Enable the "People API" for your project.
4. Go to **APIs & Services > OAuth consent screen** and configure the app
5. Go to **APIs & Services > Credentials** and click **Create Credentials > OAuth client ID**
   - Type: Web Application
   - Scopes: `openid`, `email`, `profile`
   - Authorised JS Origins: `https://<vpn domain>`
   - Authorised redirect URIs: `https://<vpn domain>/oauth2/callback`
